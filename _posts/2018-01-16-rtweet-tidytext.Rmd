---
title: "Combining the new {rtweet} and {tidytext}"
author: colin_fay
post_date: 2018-01-16
layout: single
permalink: /rtweet-tidytext/
categories: r-blog-en
output: jekyllthat::jekylldown
excerpt_separator: <!--more-->
---
On the importance of keeping your packages up to date.  

<!--more-->

I've received recently some mails and comments asking why the code in : 

+ [Collecting tweets with R and {rtweet} ](http://colinfay.me/collect-rtweet/)

+ [Visualising text data with ggplot2](https://github.com/ColinFay/conf/blob/master/2017-11-budapest/fay_colin_text_data_ggplot2.pdf)

couldn't be reproduced. 

Spoiler: this was due to the behavior of an old version of {tidytext}. As the new version is out, this problem is solved. But I thought I could use this as the perfect example to show how to go to previous version of a package :) 

## New {rtweet} vs previous {tidytext}

Last update of {rtweet} ( published on CRAN on 2017-11-16, so after I published the blogposts / slides I just mentioned) comes with a new feature: list columns. 

Problem is: you can't pass a data frame containing list-columns to `tidytext::unnest_tokens`, in version 0.1.5 of tidytext. This was prevented by the third to fifth lines of `tidytext:::unnest_tokens.data.frame`:

```{r eval = FALSE} 
if (any(!purrr::map_lgl(tbl, is.atomic))) {
  stop("unnest_tokens expects all columns of input to be atomic vectors (not lists)")
}
```

### Getting back to previous version of packages

There was no issue with the old {rtweet} and {tidytext}. To verify this, let's get back to previous versions of these two packages with the `install_version()` function from {devtools}:

```{r}
library(devtools)
install_version("rtweet", version = "0.4.0", repos = "http://cran.us.r-project.org", quiet = TRUE)
install_version("tidytext", version = "0.1.5", repos = "http://cran.us.r-project.org", quiet = TRUE)
packageVersion("rtweet")
packageVersion("tidytext")
```

```{r message = FALSE}
library(rtweet)
library(dplyr)
library(tidytext)
rtweets04 <- search_tweets("#RStats", n = 10)
glimpse(rtweets04)
```

So, no problem for doing this (as you can find in the slides): 

```{r}
rtweets04 %>% 
  unnest_tokens(word, text) %>% 
  select(screen_name, word) %>%
  slice(1:5)
```

### {rtweet} 0.6

For a while, there were an issue while trying to use these two packages ({rtweet} 0.6 was released on 2017-11-16, and {tidytext} 0.1.6 on 2018-01-07). 

Let's simulate this behavior by updating to {rtweet} 0.6, while staying at {tidytext} 0.1.5.

```{r}
detach("package:rtweet", unload=TRUE)
install.packages("rtweet", repos = "http://cran.us.r-project.org", quiet = TRUE)
packageVersion("rtweet")
packageVersion("tidytext")
```

So if I try to do the exact same thing: 

```{r error=TRUE}
library(rtweet)
rtweets06 <- search_tweets("#RStats", n = 10)
glimpse(rtweets06)
rtweets06 %>% 
  unnest_tokens(word, text) %>% 
  select(screen_name, word) %>%
  slice(1:5)
```

This doesn't work because {rtweet} results now have list columns, which throws an error when we call `unnest_tokens()` from {tidytext} 0.1.5.

But everything is now back in order with the new {tidytext} version : 

```{r}
detach("package:tidytext", unload=TRUE)
install.packages("tidytext", repos = "http://cran.us.r-project.org", quiet = TRUE)
packageVersion("tidytext")
```


```{r eval = FALSE}
rtweets06 %>% 
  tidytext::unnest_tokens(word, text) %>% 
  select(screen_name, word) %>%
  slice(1:5)
```

```
# A tibble: 5 x 2
  screen_name      word
        <chr>     <chr>
1   CheezeViz        rt
2   CheezeViz rbloggers
3   CheezeViz         a
4   CheezeViz     guide
5   CheezeViz        to
```

So, in conclusion: don't forget to update your packages!

## Workaround

Here's a {purrr} workaround I used for a while, when the two versions were not in sync. I'm just putting it there just for the sake of sharing:

```{r eval = FALSE}
library(purrr)
rtweets06 %>%
   modify_if(is.list, ~ simplify(.x) %>% paste(collapse = " "))  %>%
   tidytext::unnest_tokens(word, text) %>%
  select(screen_name, word) %>%
  slice(1:5)
```

```
# A tibble: 5 x 2
  screen_name      word
        <chr>     <chr>
1   CheezeViz        rt
2   CheezeViz rbloggers
3   CheezeViz         a
4   CheezeViz     guide
5   CheezeViz        to
```

