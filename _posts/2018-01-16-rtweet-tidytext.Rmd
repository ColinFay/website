---
title: "Combining the new {rtweet} and {tidytext}"
author: colin_fay
post_date: 2018-01-16
layout: single
permalink: /rtweet-tidytext/
categories: r-blog-en
output: jekyllthat::jekylldown
excerpt_separator: <!--more-->
---
How to deal with {rwteet} v0.6.* and {tidytext}. Spoiler: you'll need some {purrr}. 

<!--more-->

Here's a complementary post explaining why you can't reproduce exactly reproduce the code found in: 

+ [Collecting tweets with R and {rtweet} ](http://colinfay.me/collect-rtweet/) - (__This post has been updated__)

+ [Visualising text data with ggplot2](https://github.com/ColinFay/conf/blob/master/2017-11-budapest/fay_colin_text_data_ggplot2.pdf)

## New {rtweet} vs {tidytext}

Last update of {rtweet} (last published on CRAN on 2017-11-16, so after I published the blogposts / slides I just mentioned) comes with a new feature: list columns. 

Problem is: you can't pass to `tidytext::unnest_tokens` a data frame containing list-columns. This is prevented by the third to fifth lines of `tidytext:::unnest_tokens.data.frame`:

```{r eval = FALSE} 
if (any(!purrr::map_lgl(tbl, is.atomic))) {
  stop("unnest_tokens expects all columns of input to be atomic vectors (not lists)")
}
```

### Getting back to {rtweet} 0.4

This was not an issue with the old {rtweet}, as it didn't return a data frame with list-columns.

To verify this, you can get the previous version of {rtweet} with the `install_version()` function from {devtools}: 

```{r}
library(devtools)
install_version("rtweet", version = "0.4.0", repos = "http://cran.us.r-project.org")
packageVersion("rtweet")
```

```{r message = FALSE}
library(rtweet)
library(dplyr)
rtweets04 <- search_tweets("#RStats", n = 10)
glimpse(rtweets04)
```

So, no problem for doing (as you can find in the slides): 

```{r}
library(tidytext)
rtweets04 %>% 
  unnest_tokens(word, text) %>% 
  select(screen_name, word) %>%
  slice(1:5)
```

### {rtweet} 0.6

The issue occurs when we try to do the exact same thing with the new {rtweet}. Let's start by updating and checking we have the latest version. 

```{r}
detach("package:rtweet", unload=TRUE)
install.packages("rtweet", repos = "http://cran.us.r-project.org")
packageVersion("rtweet")
```

So if I try to do the exact same thing: 

```{r error=TRUE}
library(rtweet)

rtweets06 <- search_tweets("#RStats", n = 10)
glimpse(rtweets06)
rtweets06 %>% 
  unnest_tokens(word, text) %>% 
  select(screen_name, word) %>%
  slice(1:5)
```

This doesn't work because {rtweet} results now have list columns, which throws an error when we call `unnest_tokens()`. 

## Workaround

For hashtags count : 

```{r}
library(purrr)
as_vector(rtweets06$hashtags) %>% 
   table() %>% 
   as.data.frame() %>% 
   arrange(Freq) %>% 
   top_n(5)
```

For mining the `text` column: 

```{r}
rtweets06 %>% 
  discard(is.list) %>%
  unnest_tokens(word, text) %>%
  count(word, sort = TRUE) %>% 
  top_n(5)
```

But the better workaround is to turn the list columns to a vector, by combining the `modify_if` and the `simplify` functions from {purrr}: 

```{r}
rtweets06 %>% 
  modify_if(is.list, ~ simplify(.x) %>% paste(collapse = " "))  %>%
  unnest_tokens(word, text) %>%
  count(word, sort = TRUE) %>% 
  top_n(5)
```

```{r}
rtweets06 %>% 
  modify_if(is.list, ~ simplify(.x) %>% paste(collapse = " ")) %>%
  unnest_tokens(word, hashtags) %>%
  count(word, sort = TRUE) %>% 
  top_n(5)
```

